<!DOCTYPE html>
<html lang="id">
<head>
 
    <title>Sistem Pencatatan Transaksi Elektronik</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
      :root {
    --primary-color: #1a73e8;
    --primary-hover: #1557b0;
    --success-color: #34a853;
    --error-color: #ea4335;
    --warning-color: #fbbc05;
    --gray-100: #f8f9fa;
    --gray-200: #e9ecef;
    --gray-300: #dee2e6;
    --border-radius: 8px;
    --shadow: rgba(0, 0, 0, 0.1);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Arial, sans-serif;
}

body {
    padding: 20px;
    background-color: #f0f2f5;
    color: #333;
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

.card {
    background: white;
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 20px var(--shadow);
    margin-bottom: 25px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px var(--shadow);
}

h1, h2 {
    color: var(--primary-color);
    margin-bottom: 25px;
    font-weight: 600;
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #444;
}

input, select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid var(--gray-300);
    border-radius: var(--border-radius);
    margin-bottom: 10px;
    transition: border-color 0.2s, box-shadow 0.2s;
    font-size: 14px;
}

input:focus, select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 5px rgba(26, 115, 232, 0.5);
}

button {
    background-color: var(--primary-color);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    margin-right: 10px;
    font-weight: 500;
    transition: background-color 0.2s, transform 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

button:hover {
    background-color: var(--primary-hover);
    transform: translateY(-1px);
}

.filter-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    border: 1px solid var(--gray-300);
    padding: 14px;
    text-align: left;
    font-size: 14px;
    transition: background-color 0.2s;
}

th {
    background-color: var(--gray-100);
    font-weight: 600;
    position: sticky;
    top: 0;
}

th:first-child {
    border-top-left-radius: var(--border-radius);
}

th:last-child {
    border-top-right-radius: var(--border-radius);
}

tr:hover td {
    background-color: var(--gray-200);
}

.alert {
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.alert-success {
    background-color: #d4edda;
    color: var(--success-color);
    border: 1px solid #c3e6cb;
}

.alert-error {
    background-color: #f8d7da;
    color: var(--error-color);
    border: 1px solid #f5c6cb;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.summary-card {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 8px var(--shadow);
    transition: transform 0.2s, box-shadow 0.2s;
}

.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px var(--shadow);
}

.summary-card h3 {
    color: #666;
    font-size: 14px;
    margin-bottom: 10px;
}

.summary-card .value {
    font-size: 24px;
    font-weight: 600;
    color: var(--primary-color);
}

.loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.loading::after {
    content: '';
    width: 40px;
    height: 40px;
    border: 4px solid var(--gray-300);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Responsive Styles */
@media (max-width: 768px) {
    .filter-section {
        grid-template-columns: 1fr;
    }

    .summary-cards {
        grid-template-columns: 1fr;
    }

    .card {
        padding: 15px;
    }

    h1, h2 {
        font-size: 1.5em;
    }

    button {
        width: 100%;
        margin-bottom: 10px;
    }
}
  .modal {
    display: none; /* Tersembunyi secara default */
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    border: 1px solid var(--gray-300);
    padding: 10px;
    text-align: left;
}

th {
    background-color: var(--gray-100);
} </style>
</head>
<body>
    <div class="loading" id="loadingIndicator"></div>
    <div class="container">
        <div class="card">
            <h1>Sistem Pencatatan Transaksi Elektronik</h1>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Total Transaksi Hari Ini</h3>
                    <div class="value" id="todayTransactions">0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Nominal Hari Ini</h3>
                    <div class="value" id="todayAmount">Rp 0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Transaksi Bulan Ini</h3>
                    <div class="value" id="monthTransactions">0</div>
                </div>
            </div>
            
            <form id="transactionForm">
                <div class="form-group">
                    <label for="transactionType">Jenis Transaksi:</label>
                    <select id="transactionType" required>
                        <option value="">Pilih Jenis Transaksi</option>
                        <option value="pulsa">Pulsa</option>
                        <option value="paket_data">Paket Data</option>
                        <option value="top_up">Top Up E-Wallet</option>
                        <option value="token_listrik">Token Listrik</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="phoneNumber">Nomor Telepon/ID Pelanggan:</label>
                    <input type="text" id="phoneNumber" required pattern="[0-9]+" title="Masukkan hanya angka">
                </div>

                <div class="form-group">
                    <label for="amount">Nominal:</label>
                    <input type="number" id="amount" required min="1000" step="1000">
                </div>

                <div class="form-group">
                    <label for="provider">Provider:</label>
                    <select id="provider" required>
                        <option value="">Pilih Provider</option>
                    </select>
                </div>

                <button type="submit">üíæ Simpan Transaksi</button>
                <button type="reset">üîÑ Reset Form</button>
            </form>
        </div>

        <div class="card">
            <h2>Riwayat Transaksi</h2>
            
            <div class="filter-section">
                <input type="text" id="searchInput" placeholder="Cari ID Transaksi atau Nomor...">
                <input type="date" id="startDate">
                <input type="date" id="endDate">
                <select id="filterType">
                    <option value="">Semua Jenis</option>
                    <option value="pulsa">Pulsa</option>
                    <option value="paket_data">Paket Data</option>
                    <option value="top_up">Top Up E-Wallet</option>
                    <option value="token_listrik">Token Listrik</option>
                </select>
                <button onclick="applyFilters()">üîç Filter</button>
                <button onclick="resetFilters()">üîÑ Reset</button>
                <button onclick="downloadPDF()">üì• Download PDF</button>
            </div>

            <table id="transactionTable">
                <thead>
                    <tr>
                        <th>ID Transaksi</th>
                        <th>Tanggal</th>
                        <th>Jenis</th>
                        <th>Nomor/ID</th>
                        <th>Provider</th>
                        <th>Nominal</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="transactionTableBody"></tbody>
            </table>
        </div>
    </div>
<!-- Tambahkan tombol setoran di dalam card -->
<button id="depositButton">üí∞ Setoran</button>
<button id="viewAllDepositsButton">üìä Lihat Semua Data Setoran</button>

<!-- Pop-up untuk setoran -->
<div id="depositModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2>Setoran</h2>
        <label for="depositDate">Pilih Tanggal:</label>
        <input type="date" id="depositDate" required>
        <button id="showDepositData">Tampilkan Data</button>
        
        <div id="depositSummary" style="margin-top: 20px;"></div>
        <button id="saveDepositData" style="margin-top: 20px; display: none;">üíæ Simpan Data</button>
    </div>
</div>

<!-- Pop-up untuk menampilkan semua data setoran -->
<div id="allDepositsModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAllDepositsModal">&times;</span>
        <h2>Data Setoran</h2>
        
        <label for="startDate">Dari Tanggal:</label>
        <input type="date" id="startDate" />
        
        <label for="endDate">Sampai Tanggal:</label>
        <input type="date" id="endDate" />
        
        <input type="text" id="searchInput" placeholder="Cari berdasarkan ID Transaksi atau Nomor/ID" />
        <button id="filterButton">üîç Filter</button>
        <button id="downloadAllDepositsPDF" style="margin-top: 20px;">üì• Unduh Semua Data PDF</button>
        
        <div id="allDepositsSummary" style="margin-top: 20px;"></div>
    </div>
</div>

    <script>
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        // Provider options based on transaction type
        const providerOptions = {
            pulsa: ['telkomsel', 'xl', 'indosat', 'tri', 'smartfren'],
            paket_data: ['telkomsel', 'xl', 'indosat', 'tri', 'smartfren'],
            top_up: ['gopay', 'ovo', 'dana', 'linkaja'],
            token_listrik: ['pln']
        };

        
        // Storage key for localStorage
const STORAGE_KEY = 'new_transactions'; // Ganti 'new_transactions' dengan nama yang diinginkan

        // Load existing transactions from localStorage
        let transactions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

        // Update provider options based on transaction type
        document.getElementById('transactionType').addEventListener('change', function() {
            const providers = providerOptions[this.value] || [];
            const providerSelect = document.getElementById('provider');
            providerSelect.innerHTML = '<option value="">Pilih Provider</option>' +
                providers.map(p => `<option value="${p}">${(p || '').toUpperCase()}</option>`).join('');
        });

        // Generate unique transaction ID
        function generateTransactionId() {
            return 'TRX' + Date.now().toString().slice(-6) + Math.random().toString(36).substr(2, 4).toUpperCase();
        }

        // Format date for display
        function formatDate(date) {
            return new Date(date).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR'
            }).format(amount);
        }

        // Update summary statistics
        function updateSummary() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const todayTransactions = transactions.filter(t => new Date(t.date) >= today).length;
            const todayAmount = transactions
                .filter(t => new Date(t.date) >= today)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthTransactions = transactions.filter(t => new Date(t.date) >= thisMonth).length;
            
            document.getElementById('todayTransactions').textContent = todayTransactions;
            document.getElementById('todayAmount').textContent = formatCurrency(todayAmount);
            document.getElementById('monthTransactions').textContent = monthTransactions;
        }

        // Save transaction
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            document.getElementById('loadingIndicator').style.display = 'flex';

            setTimeout(() => {
                const transaction = {
                    id: generateTransactionId(),
                    date: new Date().toISOString(),
                    type: document.getElementById('transactionType').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    amount: parseInt(document.getElementById('amount').value),
                    provider: document.getElementById('provider').value
                };

                transactions.unshift(transaction);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
                
                displayTransactions(transactions);
                updateSummary();
                this.reset();

                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.innerHTML = '‚úÖ Transaksi berhasil disimpan!';
                this.insertAdjacentElement('beforebegin', alert);
                setTimeout(() => alert.remove(), 3000);

                document.getElementById('loadingIndicator').style.display = 'none';
            }, 500);
        });

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
                displayTransactions(transactions);
                updateSummary();
                
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.innerHTML = 'üóëÔ∏è Transaksi berhasil dihapus!';
                document.querySelector('.container').insertAdjacentElement('afterbegin', alert);
                setTimeout(() => alert.remove(), 3000);
            }
        }

        // Display transactions in table
        function displayTransactions(transactionsToDisplay) {
            const tbody = document.getElementById('transactionTableBody');
            tbody.innerHTML = '';

            transactionsToDisplay.forEach(transaction => {
                // Add null checks and default values
                const type = (transaction.type || '').replace('_', ' ');
                const provider = transaction.provider || '';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.id || ''}</td>
                    <td>${formatDate(transaction.date) || ''}</td>
                    <td>${type.toUpperCase()}</td>
                    <td>${transaction.phoneNumber || ''}</td>
                    <td>${provider.toUpperCase()}</td>
                    <td>${formatCurrency(transaction.amount || 0)}</td>
                    <td>
                        <button onclick="deleteTransaction('${transaction.id}')" 
                                style="background-color: var(--error-color); padding: 8px 12px;">
                            üóëÔ∏è Hapus
                        </button>
                    </td>
                `;
            });
        }

        // Apply filters
        function applyFilters() {
            document.getElementById('loadingIndicator').style.display = 'flex';

            setTimeout(() => {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const filterType = document.getElementById('filterType').value;

                let filtered = transactions;

                if (searchTerm) {
                    filtered = filtered.filter(t => 
                        t.id.toLowerCase().includes(searchTerm) ||
                        t.phoneNumber.toLowerCase().includes(searchTerm)
                    );
                }

                if (startDate && endDate) {
                    filtered = filtered.filter(t => {
                        const date = new Date(t.date);
                        return date >= new Date(startDate) && date <= new Date(endDate + 'T23:59:59');
                    });
                }

                if (filterType) {
                    filtered = filtered.filter(t => t.type === filterType);
                }

                displayTransactions(filtered);
                document.getElementById('loadingIndicator').style.display = 'none';
            }, 300);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('filterType').value = '';
            displayTransactions(transactions);
        }

        // Download PDF
        function downloadPDF() {
            document.getElementById('loadingIndicator').style.display = 'flex';

            setTimeout(() => {
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(16);
                doc.text('Laporan Transaksi Elektronik', 14, 15);
                
                // Add date and time
                doc.setFontSize(10);
                doc.text(`Dicetak pada: ${formatDate(new Date())}`, 14, 22);
                
                // Add filters info
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const filterType = document.getElementById('filterType').value;
                
                let filterInfo = 'Filter: ';
                if (startDate && endDate) {
                    filterInfo += `Periode ${startDate} s/d ${endDate}`;
                }
                if (filterType) {
                    filterInfo += ` | Jenis: ${filterType.replace('_', ' ').toUpperCase()}`;
                }
                doc.text(filterInfo, 14, 29);

                // Get visible transactions
                const visibleRows = document.getElementById('transactionTableBody').getElementsByTagName('tr');
                const data = [];
                for (let row of visibleRows) {
                    data.push([
                        row.cells[0].textContent,
                        row.cells[1].textContent,
                        row.cells[2].textContent,
                        row.cells[3].textContent,
                        row.cells[4].textContent,
                        row.cells[5].textContent
                    ]);
                }

                // Add summary
                let totalAmount = 0;
                data.forEach(row => {
                    totalAmount += parseInt(row[5].replace(/[^0-9]/g, ''));
                });

                // Create table
                doc.autoTable({
                    head: [['ID Transaksi', 'Tanggal', 'Jenis', 'Nomor/ID', 'Provider', 'Nominal']],
                    body: data,
                    startY: 35,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [26, 115, 232] }
                });

                // Add summary at the bottom
                const finalY = doc.lastAutoTable.finalY || 35;
                doc.text(`Total Transaksi: ${data.length}`, 14, finalY + 10);
                doc.text(`Total Nominal: ${formatCurrency(totalAmount)}`, 14, finalY + 20);

                // Download PDF
                doc.save('laporan-transaksi.pdf');
                document.getElementById('loadingIndicator').style.display = 'none';
            }, 500);
        }

        // Validate phone number input
        document.getElementById('phoneNumber').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Initialize
        displayTransactions(transactions);
        updateSummary();

        // Auto-update summary every minute
        setInterval(updateSummary, 60000);
        
        
function generateTransactionId() {
            const randomPart = Math.floor(10 + Math.random() * 90); // Angka acak antara 10 dan 99
            const now = new Date();
            const datePart = `${now.getDate().toString().padStart(2, '0')}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getFullYear()}${now.getHours().toString().padStart(2, '0')}`;
            return `${randomPart}-${datePart}`;
        }

        // Menampilkan pop-up setoran
        document.getElementById('depositButton').onclick = function() {
            document.getElementById('depositModal').style.display = 'block';
        }

        // Menutup pop-up
        document.getElementById('closeModal').onclick = function() {
            document.getElementById('depositModal').style.display = 'none';
        }

        // Menampilkan data transaksi berdasarkan tanggal
        document.getElementById('showDepositData').onclick = function() {
            const selectedDate = document.getElementById('depositDate').value;
            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.toISOString().slice(0, 10) === selectedDate;
            });

            let totalAmount = 0;
            const categoryTotals = {};
            const dataTable = [];

            filteredTransactions.forEach(t => {
                totalAmount += t.amount;
                categoryTotals[t.type] = (categoryTotals[t.type] || 0) + t.amount;
                dataTable.push({
                    id: t.id,
                    date: new Date(t.date).toLocaleString('id-ID'),
                    type: t.type.replace('_', ' ').toUpperCase(),
                    phoneNumber: t.phoneNumber,
                    provider: t.provider.toUpperCase(),
                    amount: new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(t.amount)
                });
            });

            let summaryHtml = `<h3>Total: ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(totalAmount)}</h3>`;
            summaryHtml += '<h4>Total Berdasarkan Kategori:</h4><ul>';
            for (const [category, amount] of Object.entries(categoryTotals)) {
                summaryHtml += `<li>${category.toUpperCase()}: ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(amount)}</li>`;
            }
            summaryHtml += '</ul>';

            // Tampilkan data transaksi dalam tabel
            let tableHtml = '<table><thead><tr><th>ID Transaksi</th><th>Tanggal</th><th>Jenis</th><th>Nomor/ID</th><th>Provider</th><th>Nominal</th></tr></thead><tbody>';
            dataTable.forEach(row => {
                tableHtml += `<tr>
                    <td>${row.id}</td>
                    <td>${row.date}</td>
                    <td>${row.type}</td>
                    <td>${row.phoneNumber}</td>
                    <td>${row.provider}</td>
                    <td>${row.amount}</td>
                </tr>`;
            });
            tableHtml += '</tbody></table>';

            document.getElementById('depositSummary').innerHTML = summaryHtml + tableHtml;
            document.getElementById('saveDepositData').style.display = 'block'; // Tampilkan tombol simpan
        }

        // Simpan data transaksi
        document.getElementById('saveDepositData').onclick = function() {
            const selectedDate = document.getElementById('depositDate').value;

            // Cek apakah ada setoran yang sudah disimpan untuk tanggal ini
            const existingDeposits = JSON.parse(localStorage.getItem('saved_deposit_' + selectedDate)) || [];

            if (existingDeposits.length > 0) {
                alert('Setoran untuk tanggal ' + selectedDate + ' sudah disimpan. Anda tidak dapat menyimpan setoran lagi untuk tanggal ini.');
                return; // Hentikan eksekusi jika setoran sudah ada
            }

            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.toISOString().slice(0, 10) === selectedDate;
            });

            // Tambahkan ID transaksi untuk setiap transaksi yang disimpan
            const transactionsWithId = filteredTransactions.map(t => {
                return {
                    ...t,
                    id: generateTransactionId() // Menghasilkan ID baru
                };
            });

            // Simpan data ke localStorage
            localStorage.setItem('saved_deposit_' + selectedDate, JSON.stringify(transactionsWithId));
            alert('Data transaksi untuk tanggal ' + selectedDate + ' telah disimpan!');
        }

        // Menutup pop-up ketika klik di luar modal
        window.onclick = function(event) {
            if (event.target == document.getElementById('depositModal')) {
                document.getElementById('depositModal').style.display = 'none';
            }
        }




   // Menampilkan pop-up untuk melihat semua data setoran
document.getElementById('viewAllDepositsButton').onclick = function() {
    document.getElementById('allDepositsModal').style.display = 'block';
    displayAllDeposits(); // Tampilkan semua data setoran saat pop-up dibuka
}

// Menutup pop-up
document.getElementById('closeAllDepositsModal').onclick = function() {
    document.getElementById('allDepositsModal').style.display = 'none';
}

// Menampilkan semua data setoran
function displayAllDeposits() {
    const deposits = Object.keys(localStorage)
        .filter(key => key.startsWith('saved_deposit_'))
        .map(key => JSON.parse(localStorage.getItem(key)))
        .flat();

    renderDeposits(deposits);
}

// Render data setoran ke dalam tabel
function renderDeposits(deposits) {
    let totalAmount = 0;
    const dataTable = [];

    deposits.forEach(t => {
        totalAmount += t.amount;
        dataTable.push({
            id: t.id,
            date: formatDate(t.date),
            type: t.type.replace('_', ' ').toUpperCase(),
            phoneNumber: t.phoneNumber,
            provider: t.provider.toUpperCase(),
            amount: formatCurrency(t.amount)
        });
    });

    // Tampilkan data transaksi dalam tabel
    let tableHtml = '<table><thead><tr><th>ID Transaksi</th><th>Tanggal</th><th>Jenis</th><th>Nomor/ID</th><th>Provider</th><th>Nominal</th></tr></thead><tbody>';
    dataTable.forEach(row => {
        tableHtml += `<tr>
            <td>${row.id}</td>
            <td>${row.date}</td>
            <td>${row.type}</td>
            <td>${row.phoneNumber}</td>
            <td>${row.provider}</td>
            <td>${row.amount}</td>
        </tr>`;
    });
    tableHtml += '</tbody></table>';

    document.getElementById('allDepositsSummary').innerHTML = `<h3>Total: ${formatCurrency(totalAmount)}</h3>` + tableHtml;
}

// Pencarian dan filter data setoran
document.getElementById('filterButton').onclick = function() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    const deposits = Object.keys(localStorage)
        .filter(key => key.startsWith('saved_deposit_'))
        .map(key => JSON.parse(localStorage.getItem(key)))
        .flat();

    const filteredDeposits = deposits.filter(t => {
        const transactionDate = new Date(t.date);
        const isWithinDateRange = (!startDate || transactionDate >= new Date(startDate)) && 
                                  (!endDate || transactionDate <= new Date(endDate));
        const matchesSearchTerm = t.id.toLowerCase().includes(searchTerm) || 
                                   t.phoneNumber.includes(searchTerm);
        return isWithinDateRange && matchesSearchTerm;
    });

    renderDeposits(filteredDeposits);
}

// Unduh semua data setoran yang difilter sebagai PDF
document.getElementById('downloadAllDepositsPDF').onclick = function() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    const deposits = Object.keys(localStorage)
        .filter(key => key.startsWith('saved_deposit_'))
        .map(key => JSON.parse(localStorage.getItem(key)))
        .flat();

    const filteredDeposits = deposits.filter(t => {
        const transactionDate = new Date(t.date);
        const isWithinDateRange = (!startDate || transactionDate >= new Date(startDate)) && 
                                  (!endDate || transactionDate <= new Date(endDate));
        const matchesSearchTerm = t.id.toLowerCase().includes(searchTerm) || 
                                   t.phoneNumber.includes(searchTerm);
        return isWithinDateRange && matchesSearchTerm;
    });

    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text('Laporan Setoran', 14, 15);
    
    let totalAmount = 0;
    const dataTable = [];

    filteredDeposits.forEach(t => {
        totalAmount += t.amount;
        dataTable.push([
            t.id,
            formatDate(t.date),
            t.type.replace('_', ' ').toUpperCase(),
            t.phoneNumber,
            t.provider.toUpperCase(),
            formatCurrency(t.amount)
        ]);
    });

    // Create table
    doc.autoTable({
        head: [['ID Transaksi', 'Tanggal', 'Jenis', 'Nomor/ID', 'Provider', 'Nominal']],
        body: dataTable,
        startY: 35,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [26, 115, 232] }
    });

    // Add total amount
    const finalY = doc.lastAutoTable.finalY || 35;
    doc.text(`Total: ${formatCurrency(totalAmount)}`, 14, finalY + 10);

    // Download PDF dengan nama file berdasarkan rentang tanggal
    const fileName = `laporan_setoran_${startDate}_sampai_${endDate}.pdf`;
    doc.save(fileName);
}

// Menutup pop-up ketika klik di luar modal
window.onclick = function(event) {
    if (event.target == document.getElementById('allDepositsModal')) {
        document.getElementById('allDepositsModal').style.display = 'none';
    }
}     
    </script>
</body>
</html>